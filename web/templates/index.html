<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Research AI - Voice Consultation</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .htmx-indicator {
            opacity: 0;
            transition: opacity 500ms ease-in;
        }
        .htmx-request .htmx-indicator {
            opacity: 1;
        }
        .recording {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .urgency-emergency { @apply bg-red-100 border-red-500 text-red-800; }
        .urgency-high { @apply bg-orange-100 border-orange-500 text-orange-800; }
        .urgency-moderate { @apply bg-yellow-100 border-yellow-500 text-yellow-800; }
        .urgency-low { @apply bg-green-100 border-green-500 text-green-800; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-gray-900">üè• Medical Research AI</h1>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500">Patient:</span>
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">Anonymous</span>
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-sm">‚úì Consented</span>
                    </div>
                </div>
                <div id="health-status" class="flex items-center space-x-2">
                    <div class="flex items-center space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                        <span class="text-sm text-gray-500">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Panel -->
            <div class="space-y-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Voice Input</h2>
                    
                    <!-- Voice Recording -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-center">
                            <button id="record-btn" 
                                    class="w-24 h-24 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center text-2xl transition-colors"
                                    onclick="toggleRecording()">
                                üé§
                            </button>
                        </div>
                        <div class="text-center">
                            <span id="recording-status" class="text-sm text-gray-500">Click to start recording</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="audio-level" class="bg-blue-600 h-2 rounded-full transition-all duration-100" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- File Upload -->
                    <div class="mt-6 pt-6 border-t">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Or upload audio file</label>
                        <input type="file" id="audio-file" accept="audio/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                </div>

                <!-- Text Input -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Text Input</h2>
                    <form hx-post="/api/consultation/text" 
                          hx-target="#results-panel" 
                          hx-swap="innerHTML"
                          hx-indicator="#text-loading">
                        <div class="space-y-4">
                            <div>
                                <label for="symptoms" class="block text-sm font-medium text-gray-700 mb-2">Describe your symptoms</label>
                                <textarea id="symptoms" name="symptoms" rows="4" 
                                         class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                         placeholder="I have been experiencing..."></textarea>
                            </div>
                            
                            <!-- Patient Demographics -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="patient_age" class="block text-sm font-medium text-gray-700 mb-1">Age</label>
                                    <input type="number" id="patient_age" name="patient_age" 
                                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="35">
                                </div>
                                <div>
                                    <label for="patient_gender" class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                                    <select id="patient_gender" name="patient_gender" 
                                            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Select...</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label for="medical_history" class="block text-sm font-medium text-gray-700 mb-1">Medical History</label>
                                <input type="text" id="medical_history" name="medical_history" 
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="hypertension, diabetes (comma-separated)">
                            </div>
                            
                            <button type="submit" 
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                                Analyze Symptoms
                                <span id="text-loading" class="htmx-indicator ml-2">‚è≥</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="space-y-6">
                <div id="results-panel" class="bg-white rounded-lg shadow p-6">
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">ü©∫</div>
                        <p>Enter symptoms or record audio to begin analysis</p>
                    </div>
                </div>

                <!-- Health Monitoring -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">System Health</h2>
                    <div id="health-panel" class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">Loading health status...</span>
                            <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket for health monitoring
        let healthWs = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        // Initialize WebSocket connection
        function initHealthWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            healthWs = new WebSocket(`${protocol}//${window.location.host}/ws/health`);
            
            healthWs.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'health_update') {
                    updateHealthPanel(data.data);
                }
            };
            
            healthWs.onclose = function() {
                setTimeout(initHealthWebSocket, 5000); // Reconnect after 5 seconds
            };
        }

        // Update health panel
        function updateHealthPanel(healthData) {
            const panel = document.getElementById('health-panel');
            const statusHeader = document.getElementById('health-status');
            
            let html = '';
            let overallStatus = 'healthy';
            
            // Voice interface status
            if (healthData.voice_interface_available) {
                html += `<div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Voice Interface</span>
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                </div>`;
            } else {
                html += `<div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Voice Interface</span>
                    <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                </div>`;
                overallStatus = 'degraded';
            }
            
            // Add supported languages
            if (healthData.supported_languages) {
                html += `<div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Languages: ${healthData.supported_languages.join(', ')}</span>
                    <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                </div>`;
            }
            
            panel.innerHTML = html;
            
            // Update header status
            const statusColor = overallStatus === 'healthy' ? 'green' : 'yellow';
            statusHeader.innerHTML = `
                <div class="flex items-center space-x-1">
                    <div class="w-2 h-2 bg-${statusColor}-500 rounded-full"></div>
                    <span class="text-sm text-gray-600">${overallStatus}</span>
                </div>
            `;
        }

        // Voice recording functions
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await submitVoiceConsultation(audioBlob);
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                document.getElementById('record-btn').classList.add('recording', 'bg-red-600');
                document.getElementById('recording-status').textContent = 'Recording... Click to stop';
                
            } catch (error) {
                console.error('Error starting recording:', error);
                alert('Could not access microphone. Please check permissions.');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                
                document.getElementById('record-btn').classList.remove('recording', 'bg-red-600');
                document.getElementById('recording-status').textContent = 'Processing...';
            }
        }

        async function submitVoiceConsultation(audioBlob) {
            const formData = new FormData();
            formData.append('audio_file', audioBlob, 'recording.wav');
            
            // Add patient demographics if filled
            const age = document.getElementById('patient_age').value;
            const gender = document.getElementById('patient_gender').value;
            const history = document.getElementById('medical_history').value;
            
            if (age) formData.append('patient_age', age);
            if (gender) formData.append('patient_gender', gender);
            if (history) formData.append('medical_history', history);
            
            try {
                const response = await fetch('/api/consultation/voice', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                displayResults(result);
                
            } catch (error) {
                console.error('Error submitting voice consultation:', error);
                document.getElementById('recording-status').textContent = 'Error processing audio';
            }
        }

        function displayResults(result) {
            const panel = document.getElementById('results-panel');
            
            if (result.success) {
                const analysis = result.analysis;
                const urgencyClass = `urgency-${analysis.urgency}`;
                
                let html = `
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Analysis Results</h3>
                            <span class="px-3 py-1 rounded-full text-sm font-medium border ${urgencyClass}">
                                ${analysis.urgency.toUpperCase()}
                            </span>
                        </div>
                `;
                
                if (result.transcription) {
                    html += `
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 mb-2">Transcription</h4>
                            <p class="text-gray-700">${result.transcription}</p>
                        </div>
                    `;
                }
                
                html += `
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 mb-2">Medical Response</h4>
                        <p class="text-gray-700">${analysis.patient_friendly_response}</p>
                    </div>
                `;
                
                if (analysis.recommendations && analysis.recommendations.length > 0) {
                    html += `
                        <div>
                            <h4 class="font-medium text-gray-900 mb-2">Recommendations</h4>
                            <ul class="list-disc list-inside space-y-1">
                    `;
                    analysis.recommendations.forEach(rec => {
                        html += `<li class="text-gray-700">${rec}</li>`;
                    });
                    html += `</ul></div>`;
                }
                
                if (analysis.red_flags && analysis.red_flags.length > 0) {
                    html += `
                        <div class="bg-red-50 rounded-lg p-4">
                            <h4 class="font-medium text-red-900 mb-2">‚ö†Ô∏è Important Warnings</h4>
                            <ul class="list-disc list-inside space-y-1">
                    `;
                    analysis.red_flags.forEach(flag => {
                        html += `<li class="text-red-700">${flag}</li>`;
                    });
                    html += `</ul></div>`;
                }
                
                html += `
                    <div class="text-xs text-gray-500 pt-4 border-t">
                        Model: ${analysis.model_used} | Confidence: ${(analysis.confidence * 100).toFixed(1)}%
                        ${result.processing_time_ms ? ` | Processing: ${result.processing_time_ms}ms` : ''}
                    </div>
                </div>
                `;
                
                panel.innerHTML = html;
            } else {
                panel.innerHTML = `
                    <div class="text-center text-red-600 py-8">
                        <div class="text-4xl mb-4">‚ùå</div>
                        <p>Analysis failed. Please try again.</p>
                    </div>
                `;
            }
            
            document.getElementById('recording-status').textContent = 'Click to start recording';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initHealthWebSocket();
            
            // Handle file upload
            document.getElementById('audio-file').addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (file) {
                    await submitVoiceConsultation(file);
                }
            });
        });

        // HTMX response handler for text consultations
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.xhr.status === 200 && evt.detail.target.id === 'results-panel') {
                try {
                    const result = JSON.parse(evt.detail.xhr.responseText);
                    displayResults(result);
                } catch (e) {
                    console.error('Error parsing response:', e);
                }
            }
        });
    </script>
</body>
</html>
